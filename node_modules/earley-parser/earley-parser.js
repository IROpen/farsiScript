var Grammar,ParserStore,Tokenizer,copyState,debugNestedArrays,debugState,equalArrays,getNext,bind=function(e,t){return function(){return e.apply(t,arguments)}},slice=[].slice;getNext=function(e){return e.pos<e.rhs.length?e.rhs[e.pos]:null},copyState=function(e){return{lhs:e.lhs,rhs:e.rhs,pos:e.pos,ori:e.ori,got:e.got.slice(0)}},equalArrays=function(e,t){var r,n,s,o,i;if(e.length!==t.length)return!1;for(s=o=0,i=e.length;o<i;s=++o)if(r=e[s],n=t[s],r instanceof RegExp){if(!(n instanceof RegExp)||r.source!==n.source)return!1}else if(r!==n)return!1;return!0},Grammar=function(){function e(e){this.START=e,this.parse=bind(this.parse,this),this.addRule=bind(this.addRule,this),this.setOption=bind(this.setOption,this),this.rules={},this.defaults={addCategories:!0,collapseBranches:!1,showDebuggingOutput:!1,expressionBuilder:null,tokenizer:null,comparator:JSON.equals,maxIterations:-1}}return e.prototype.setOption=function(e,t){return this.defaults[e]=t},e.prototype.addRule=function(){var e,t,r,n,s,o,i,a,l,u,h;for(t=arguments[0],l=[],s=0,o=(h=2<=arguments.length?slice.call(arguments,1):[]).length;s<o;s++){for((u=h[s])instanceof RegExp&&(u=[u]),u instanceof Array||(u=(""+u).split(" ")),n=a=0,i=u.length;a<i;n=++a)(r=u[n])instanceof RegExp&&(u[n]=new RegExp("^"+r.source+"$"));l.push((null!=(e=this.rules)[t]?e[t]:e[t]=[]).push(u))}return l},e.prototype.parse=function(e,t){var r,n,s,o,i,a,l,u,h,p,f,c,g,d,y,x,m,b,S,k,w,O,z,R,T,A,v,N,B,E,P,G,j,q,I,J,C,D,M,$,F,W,L,U,Z,H,K;for(null==t&&(t={}),null==t.addCategories&&(t.addCategories=this.defaults.addCategories),null==t.collapseBranches&&(t.collapseBranches=this.defaults.collapseBranches),null==t.showDebuggingOutput&&(t.showDebuggingOutput=this.defaults.showDebuggingOutput),null==t.expressionBuilder&&(t.expressionBuilder=this.defaults.expressionBuilder),s={},null==t.tokenizer&&(t.tokenizer=this.defaults.tokenizer),null==t.comparator&&(t.comparator=this.defaults.comparator),null==t.maxIterations&&(t.maxIterations=this.defaults.maxIterations),(n=t.showDebuggingOutput?function(){return console.log.apply(console,arguments)}:function(){})("\n\n"),null!=t.tokenizer&&"string"==typeof e&&(e=t.tokenizer.tokenize(e)),($=function(){var t,r,n;for(n=[],a=t=0,r=e.length;0<=r?t<=r:t>=r;a=0<=r?++t:--t)n.push([]);return n}())[0].push({lhs:"",rhs:[this.START],pos:0,ori:0,got:[]}),S=0,a=h=0,p=$.length;h<p;a=++h){for(F=$[a],n("processing stateSet "+a+" in this stateGrid (with input "+e+"):"),n("----------------------"),L=x=0,T=$.length;0<=T?x<T:x>T;L=0<=T?++x:--x){for(n("|    state set "+L+":"),D=0,U=m=0,A=$[L].length;0<=A?m<A:m>A;U=0<=A?++m:--m)$[L].length<15||$[L][U].pos>0?n("|        entry "+U+": "+debugState($[L][U])):D++;D>0&&n("|    (plus "+D+" at pos 0 not shown)")}for(n("----------------------"),l=0;l<F.length;)if(M=F[l],n("entry "+l+":",debugState(M)),b=getNext(M),n("next:",b),null!==b)if(a>=e.length)l++;else if(n("is it a terminal?",b instanceof RegExp),b instanceof RegExp)b.test(e[a])&&((r=copyState(M)).pos++,r.got.push(e[a]),$[a+1].push(r),n("scanner added this to "+(a+1)+":",debugState(r))),l++;else{if(!this.rules.hasOwnProperty(b))throw"Unknown non-terminal in grammar rule: "+b;for(n("rhss: ["+(J=this.rules[b]).join("],[")+"]"),u=O=0,c=J.length;O<c;u=++O){for(I=J[u],o=!1,z=0,g=F.length;z<g;z++)if((C=F[z]).lhs===b&&equalArrays(C.rhs,I)&&0===C.pos){o=!0;break}o||(F.push({lhs:b,rhs:I,pos:0,ori:a,got:[]}),n("adding this state:",debugState(F[F.length-1])))}if(l++,S++>(B=t.maxIterations)&&B>0)throw"Maximum number of iterations reached."}else{for(n("considering if this completion matters to state set",M.ori),u=k=0,f=(v=$[M.ori]).length;k<f;u=++k)if(C=v[u],getNext(C)===M.lhs&&(C=copyState(C),C.pos++,i=M.got.slice(0),t.addCategories&&i.unshift(M.lhs),null!=t.expressionBuilder&&i.unshift(s),t.collapseBranches&&1===i.length&&(i=i[0]),C.got.push(i),$[a].push(C),n("completer added this to "+a+":",debugState(C)),S++>(N=t.maxIterations)&&N>0))throw"Maximum number of iterations reached.";l++}}for(n("finished processing this stateGrid (with input "+e+"):"),n("----------------------"),L=W=0,E=$.length;0<=E?W<E:W>E;L=0<=E?++W:--W){for(n("|    state set "+L+":"),D=0,U=Z=0,P=$[L].length;0<=P?Z<P:Z>P;U=0<=P?++Z:--Z)$[L].length<15||$[L][U].pos>0?n("|        entry "+U+": "+debugState($[L][U])):D++;D>0&&n("|    (plus "+D+" at pos 0 not shown)")}for(n("----------------------"),q=[],H=0,d=(G=$[$.length-1]).length;H<d;H++)if(""===(F=G[H]).lhs&&null===getNext(F)){if(j=F.got[0],null!=t.expressionBuilder&&(R=function(e){var r,n;return e instanceof Array&&e[0]===s?(1===(r=function(){var t,r,s,o;for(s=[],o=0,t=(r=e.slice(1)).length;o<t;o++)n=r[o],s.push(R(n));return s}()).length&&t.collapseBranches&&(r=r[0]),r.indexOf(void 0)>-1?void 0:t.expressionBuilder(r)):e},null==(j=R(j))))continue;for(o=!1,K=0,y=q.length;K<y;K++)if(w=q[K],t.comparator(w,j)){o=!0;break}o||q.push(j)}return q},e}(),Tokenizer=function(){function e(){this.tokenize=bind(this.tokenize,this),this.addType=bind(this.addType,this),this.tokenTypes=[]}return e.prototype.addType=function(e,t){return null==t&&(t=function(e){return e}),"^"!==e.source[0]&&(e=new RegExp("^(?:"+e.source+")")),this.tokenTypes.push({regexp:e,formatter:t})},e.prototype.tokenize=function(e){var t,r,n,s,o,i,a,l,u,h;for(l=[];e.length>0;){for(i=e.length,r=0,n=(a=this.tokenTypes).length;r<n;r++)if(h=a[r],s=h.regexp.exec(e)){if(e=e.slice(s[0].length),h.formatter instanceof Function)null!=(o=h.formatter(s[0],s))&&l.push(o);else{for(t=""+h.formatter,u="";o=/\%([0-9]+)/.exec(t);)u+=t.slice(0,o.index)+s[o[1]],t=t.slice(o.index+o[0].length);l.push(u+t)}break}if(e.length===i)return null}return l},e}(),debugNestedArrays=function(e){return e instanceof Array?("{}"===JSON.stringify(e[0])&&(e=e.slice(1)),"["+e.map(debugNestedArrays).join(",")+"]"):e},debugState=function(e){return"("+e.lhs+" -> "+e.pos+"in["+e.rhs+"], "+e.ori+") got "+debugNestedArrays(e.got)},JSON.equals=function(e,t){var r,n,s,o,i;if(e instanceof Object!=t instanceof Object)return!1;if(e instanceof Array!=t instanceof Array)return!1;if(!(e instanceof Object))return e===t;if(o=Object.keys(e).sort(),i=Object.keys(t).sort(),JSON.stringify(o)!==JSON.stringify(i))return!1;for(n=0,s=o.length;n<s;n++)if(r=o[n],!JSON.equals(e[r],t[r]))return!1;return!0},"undefined"!=typeof exports&&null!==exports&&(exports.Grammar=Grammar,exports.Tokenizer=Tokenizer),("undefined"!=typeof WorkerGlobalScope&&null!==WorkerGlobalScope||null!=("undefined"!=typeof self&&null!==self?self.importScripts:void 0))&&(ParserStore={},self.addEventListener("message",function(e){var t,r,n,s,o,i,a,l,u,h,p,f,c,g,d,y,x,m,b,S,k,w,O,z,R;switch(e.data[0]){case"newParser":return d=e.data,d[0],g=d[1],z=d[2],ParserStore[g]=new Grammar(z);case"addType":if(y=e.data,y[0],g=y[1],S=y[2],o=y[3],null==(t=ParserStore[g]))return;return i=/\s*function\s*\(((?:[a-zA-Z0-9,]|\s)*)\)\s*\{\s*((?:.|\n)*)\}\s*$/,o&&((c=i.exec(o))[1]=c[1].replace(/\s/g,""),o=function(e,t,r){r.prototype=e.prototype;var n=new r,s=e.apply(n,t);return Object(s)===s?s:n}(Function,c.slice(1),function(){})),null==(r=t.defaults).tokenizer&&(r.tokenizer=new Tokenizer),t.defaults.tokenizer.addType(new RegExp(S),o);case"addRule":if(x=e.data,x[0],g=x[1],n=x[2],O=4<=x.length?slice.call(x,3):[],null==(t=ParserStore[g]))return;for(a=u=0,h=O.length;u<h;a=++u)for(w=O[a],/^t:/.test(w)&&(O[a]=[new RegExp(w.slice(2))]),w instanceof Array||(O[a]=w=(""+w).split(" ")),l=f=0,p=w.length;f<p;l=++f)k=(s=w[l]).slice(2),"t"===s[0]&&(k=new RegExp("^"+k+"$")),w[l]=k;return t.addRule.apply(t,[n].concat(slice.call(O)));case"parse":if(m=e.data,m[0],g=m[1],R=m[2],null==(t=ParserStore[g]))return;return self.postMessage(t.parse(R));case"deleteParser":return b=e.data,b[0],g=b[1],delete ParserStore[g]}}));
//# sourceMappingURL=earley-parser.js.map
